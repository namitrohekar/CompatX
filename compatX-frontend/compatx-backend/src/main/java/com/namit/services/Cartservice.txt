package com.namit.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.namit.dto.cart.AddToCartDTO;
import com.namit.dto.cart.CartItemResponseDTO;
import com.namit.dto.cart.CartResponseDTO;
import com.namit.dto.cart.ProductInCartDTO;
import com.namit.dto.cart.UpdateCartItemDTO;
import com.namit.models.AppUser;
import com.namit.models.Cart;
import com.namit.models.CartItem;
import com.namit.models.Product;
import com.namit.repository.AppUserRepository;
import com.namit.repository.CartItemRepository;
import com.namit.repository.CartRepository;
import com.namit.repository.ProductRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
@Transactional
public class CartService {

    private final CartRepository cartRepository;
    private final CartItemRepository cartItemRepository;
    private final ProductRepository productRepository;
    private final AppUserRepository userRepository;

    /**
     * Get user's cart
     */
    @Transactional(readOnly = true)
    public CartResponseDTO getCart(Long userId) {
        Cart cart = getOrCreateCart(userId);
        return mapToCartResponse(cart);
    }

    /**
     * Add item to cart
     */
    public CartResponseDTO addToCart(Long userId, AddToCartDTO request) {
        // Validate product exists and has stock
        Product product = productRepository.findById(request.getProductId())
            .orElseThrow(() -> new RuntimeException("Product not found"));

        if (product.getStock() < request.getQuantity()) {
            throw new RuntimeException("Insufficient stock. Available: " + product.getStock());
        }

        // Get or create cart
        Cart cart = getOrCreateCart(userId);

        // Check if product already in cart
        CartItem existingItem = cartItemRepository
            .findByCart_CartIdAndProduct_Id(cart.getCartId(), product.getId())
            .orElse(null);

        if (existingItem != null) {
            // Update existing item
            int newQuantity = existingItem.getQuantity() + request.getQuantity();
            
            if (product.getStock() < newQuantity) {
                throw new RuntimeException("Cannot add more. Available stock: " + product.getStock());
            }
            
            existingItem.setQuantity(newQuantity);
            cartItemRepository.save(existingItem);
        } else {
            // Create new cart item
            CartItem cartItem = new CartItem();
            cartItem.setCart(cart);
            cartItem.setProduct(product);
            cartItem.setQuantity(request.getQuantity());
            cartItem.setPriceAtAdd(product.getPrice());
            
            cart.addItem(cartItem);
            cartItemRepository.save(cartItem);
        }

        cartRepository.save(cart);
        return mapToCartResponse(cart);
    }

    /**
     * Update cart item quantity
     */
    public CartResponseDTO updateCartItem(Long userId, Long cartItemId, UpdateCartItemDTO request) {
        CartItem cartItem = cartItemRepository.findByIdAndUserId(cartItemId, userId)
            .orElseThrow(() -> new RuntimeException("Cart item not found"));

        Product product = cartItem.getProduct();

        // Validate stock
        if (product.getStock() < request.getQuantity()) {
            throw new RuntimeException("Insufficient stock. Available: " + product.getStock());
        }

        cartItem.setQuantity(request.getQuantity());
        cartItemRepository.save(cartItem);

        Cart cart = cartItem.getCart();
        return mapToCartResponse(cart);
    }

    /**
     * Remove item from cart
     */
    public CartResponseDTO removeCartItem(Long userId, Long cartItemId) {
        CartItem cartItem = cartItemRepository.findByIdAndUserId(cartItemId, userId)
            .orElseThrow(() -> new RuntimeException("Cart item not found"));

        Cart cart = cartItem.getCart();
        cart.removeItem(cartItem);
        cartItemRepository.delete(cartItem);
        
        return mapToCartResponse(cart);
    }

    /**
     * Clear entire cart
     */
    public void clearCart(Long userId) {
        Cart cart = cartRepository.findByUser_UserId(userId)
            .orElseThrow(() -> new RuntimeException("Cart not found"));

        cart.clearItems();
        cartItemRepository.deleteByCart_CartId(cart.getCartId());
        cartRepository.save(cart);
    }

    /**
     * Get cart item count
     */
    @Transactional(readOnly = true)
    public Integer getCartItemCount(Long userId) {
        Cart cart = cartRepository.findByUser_UserId(userId).orElse(null);
        if (cart == null) {
            return 0;
        }
        return cartItemRepository.getTotalQuantityByCartId(cart.getCartId());
    }

    /**
     * Helper: Get or create cart for user
     */
    private Cart getOrCreateCart(Long userId) {
        return cartRepository.findByUserIdWithItems(userId)
            .orElseGet(() -> {
                AppUser user = userRepository.findById(userId)
                    .orElseThrow(() -> new RuntimeException("User not found"));
                
                Cart newCart = new Cart();
                newCart.setUser(user);
                return cartRepository.save(newCart);
            });
    }

    /**
     * Helper: Map Cart entity to CartResponseDTO
     */
    private CartResponseDTO mapToCartResponse(Cart cart) {
        List<CartItemResponseDTO> itemDTOs = cart.getItems().stream()
            .map(this::mapToCartItemResponse)
            .collect(Collectors.toList());

        return CartResponseDTO.builder()
            .cartId(cart.getCartId())
            .items(itemDTOs)
            .totalItems(cart.getTotalItems())
            .totalPrice(cart.getTotalPrice())
            .updatedAt(cart.getUpdatedAt())
            .build();
    }

    /**
     * Helper: Map CartItem to CartItemResponseDTO
     */
    private CartItemResponseDTO mapToCartItemResponse(CartItem item) {
        Product product = item.getProduct();

        ProductInCartDTO productDTO = ProductInCartDTO.builder()
            .productId(product.getId())
            .productName(product.getProductName())
            .brand(product.getBrand())
            .imageUrl(product.getImageUrl())
            .availableStock(product.getStock())
            .currentPrice(product.getPrice())
            .build();

        return CartItemResponseDTO.builder()
            .cartItemId(item.getCartItemId())
            .product(productDTO)
            .quantity(item.getQuantity())
            .priceAtAdd(item.getPriceAtAdd())
            .subtotal(item.getSubtotal())
            .build();
    }
}